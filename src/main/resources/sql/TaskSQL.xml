<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="taskMapper">

	<!-- 업무 시퀀스 조회 -->
	<select id="getTaskSeq" resultType="int">
	select task_SEQ.nextval from dual
	</select>
	
	<!-- 업무 등록 -->
   	<insert id="insertTask" parameterType="taskDTO">
    insert into task(task_no,task_state,task_content,task_priority)
    values(
    #{task_no},#{task_state},#{task_content},#{task_priority}
    )
	</insert>
	
	<!-- 업무 등록(담당자) -->
	<insert id="insertTaskPi" parameterType="taskDTO">
	insert into participants(cont_kind,cont_no,mem_no) 
	values(
	#{cont_kind},#{cont_no},#{mem_no}
	)
	</insert>
	
	<!-- 업무 등록(시작일) -->
	<insert id="insertTaskStartDate" parameterType="taskDTO">
	insert into time(cont_kind,cont_no,time_kind,time_date)
	values(
	#{cont_kind},#{cont_no},'s',TO_DATE(#{task_start_date},'YYYY/MM/DD HH24:MI')
	)
	</insert>
	
	<!-- 업무 등록(마감일) -->
	<insert id="insertTaskEndDate" parameterType="taskDTO">
	insert into time(cont_kind,cont_no,time_kind,time_date)
	values(
	#{cont_kind},#{cont_no},'e',TO_DATE(#{task_end_date},'YYYY/MM/DD HH24:MI')
	)
	</insert>
	
	<!-- 업무 등록(시작일,마감일) -->
	<insert id="insertTaskDate" parameterType="taskDTO">
	insert all 
	into time(cont_kind,cont_no,time_kind,time_date)
	values(
	#{cont_kind},#{cont_no},'s',TO_DATE(#{task_start_date},'YYYY/MM/DD HH24:MI')
	)
	into time(cont_kind,cont_no,time_kind,time_date)
	values(
	#{cont_kind},#{cont_no},'e',TO_DATE(#{task_end_date},'YYYY/MM/DD HH24:MI')
	)
	select * from dual
	</insert>
	
	<!-- 업무 등록에 쓰는거 TIM_NO, CONT_KIND, CONT_NO, TIM_CONT, TIM_DATE, PRO_NO, MEM_NO -->
    <insert id="insertTaskTim" parameterType="taskDTO">
    	insert into timeline
		values (timeline_seq.nextval,#{cont_kind},0,#{task_title},sysdate,#{pro_no},#{mem_no})
    </insert>
    
    <select id="selectAllTask" parameterType="String" resultType="taskDTO">
		select t.*
		,(select tim_cont from timeline where timeline.cont_kind = ti.cont_kind) AS tim_cont,p.*,ti.*,pro.pro_no AS pro_no
		,(select mem_email from member m where m.mem_no = p.mem_no) AS mem_email,pro.pro_name AS pro_name
		,(select mem_name from member m where m.mem_no = p.mem_no) AS mem_nick
		from task t,participants p,time ti
		,(select m.*,pu.* from member m, project_user pu where m.mem_no=pu.mem_no AND mem_email = #{mem_email}) pu
		,(select * from project) pro
		where t.task_no = p.cont_no
		AND  t.task_no = ti.cont_no
		AND p.mem_no = pro.mem_no
		AND  pu.pro_no = pro.pro_no
		order by task_no desc
    </select>
	
	<!-- 업무 수정 -->
	<update id="updateTask" parameterType="taskDTO">
	update task set 
	task_title = #{task_title},
	task_content = #{task_content},
	task_state = #{task_state},
	task_priority = #{task_priority}
	where task_no = #{task_no}
	</update>
	
	<!-- 업무 삭제 -->
	<delete id="deleteTask" parameterType="taskDTO">
	delete from task where task_no = #{task_no}
	</delete>
	
	
</mapper>